package iterator

import (
	"testing"

	"gitlab.alibaba-inc.com/fengjin.hf/cement/buffer"
	ut "gitlab.alibaba-inc.com/fengjin.hf/cement/unittest"
	"gitlab.alibaba-inc.com/fengjin.hf/g53"
	"gitlab.alibaba-inc.com/fengjin.hf/g53/util"
)

func TestMessageClassify(t *testing.T) {
	cases := []struct {
		raw      string
		zone     string
		qname    string
		typ      g53.RRType
		category ResponseCategory
	}{
		{"cb7b830000010000000d000b05626169647503636f6d0000010001c012000200010002a3000014016c0c67746c642d73657276657273036e657400c012000200010002a30000040162c029c012000200010002a30000040163c029c012000200010002a30000040164c029c012000200010002a30000040165c029c012000200010002a30000040166c029c012000200010002a30000040167c029c012000200010002a30000040161c029c012000200010002a30000040168c029c012000200010002a30000040169c029c012000200010002a3000004016ac029c012000200010002a3000004016bc029c012000200010002a3000004016dc029c027000100010002a3000004c029a21ec027001c00010002a300001020010500d93700000000000000000030c047000100010002a3000004c0210e1ec047001c00010002a300001020010503231d00000000000000020030c057000100010002a3000004c01a5c1ec057001c00010002a30000102001050383eb00000000000000000030c067000100010002a3000004c01f501ec067001c00010002a300001020010500856e00000000000000000030c077000100010002a3000004c00c5e1ec077001c00010002a3000010200105021ca100000000000000000030c087000100010002a3000004c023331e", ".", "baidu.com", g53.RR_A, Referral},
		{"04b08500000100000001000103636f6d0000230001c00c0006000100000384003d01610c67746c642d73657276657273036e657400056e73746c640c766572697369676e2d677273c00c5fa9f40a000007080000038400093a80000151800000291000000000000000", "com", "com", g53.RR_NAPTR, NXRRset},
		{"cb7b818000010001000000000377777706676f6f676c6503636f6d0000010001c00c000100010000012b0004acd9a064", "google.com", "www.google.com.", g53.RR_A, Answer},
		{"04b0850300010000000100010b656565657878787865656503636f6d0000230001c0180006000100000384003d01610c67746c642d73657276657273036e657400056e73746c640c766572697369676e2d677273c0185fa9fc66000007080000038400093a80000151800000291000000000000000", "com", "eeeexxxxeee.com", g53.RR_NAPTR, NXDomain},
		{"04b0850000010001000400010377777706616d617a6f6e03636f6d0000010001c00c00050001000007080018027470123437636632633863392d66726f6e74696572c010123437636632633863392d66726f6e74696572c01000020001000003840013066e732d34373709617773646e732d3539c017c02f00020001000003840017076e732d3134303409617773646e732d3437036f726700c02f00020001000003840016066e732d35353309617773646e732d3035036e657400c02f00020001000003840019076e732d3138383109617773646e732d343302636f02756b000000291000000000000000", "amazon.com", "www.amazon.com", g53.RR_A, CName},
		{"672d818000010003000000000377777705626169647503636f6d0000010001c00c000500010000034a000f0377777701610673686966656ec016c02b000100010000004c0004b465310cc02b000100010000004c0004b465310b", "com", "www.baidu.com", g53.RR_A, CNameAnswer},
	}

	for _, c := range cases {
		wire, _ := util.HexStrToBytes(c.raw)
		buf := buffer.NewInputBuffer(wire)
		resp, _ := g53.MessageFromWire(buf)
		category, err := SanitizeClassifyResponse(g53.NameFromStringUnsafe(c.zone), g53.NameFromStringUnsafe(c.qname), c.typ, resp)
		ut.Assert(t, err == nil, "%v", err)
		ut.Equal(t, category, c.category)
	}
}
